<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Django Math Stumper - ODE Challenge</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .equation-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 20px;
            overflow-x: auto; /* Enable horizontal scrolling if needed */
            white-space: nowrap; /* Prevent wrapping */
        }

        .equation-row {
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 800px; /* Ensure minimum width to prevent wrapping */
        }

        .equation-label {
            font-weight: bold;
            min-width: 120px;
            color: #2c3e50;
        }

        .latex-equation {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            flex: 1;
            overflow-x: auto;
            white-space: nowrap;
            background: white;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .conditions-display {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button.secondary {
            background: #95a5a6;
        }

        button.secondary:hover {
            background: #7f8c8d;
        }

        .solution-input {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="number"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            color: #666;
            font-style: italic;
        }

        .details {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üßÆ Django Math Stumper</h1>
        <p>Challenge AI agents with procedurally generated nonlinear ODE systems</p>
    </div>

    <div class="container">
        <div class="card">
            <h2>üéØ Current Challenge</h2>
            <div id="loading" class="loading">Generating new challenge...</div>

            <div id="equation-section" style="display: none;">
                <div class="equation-display">
                    <h3>System of Equations:</h3>
                    <div class="equation-row">
                        <span id="eq-dx" class="latex-equation"></span>
                    </div>
                    <div class="equation-row">
                        <span id="eq-dy" class="latex-equation"></span>
                    </div>
                    <div class="equation-row">
                        <span id="eq-dz" class="latex-equation"></span>
                    </div>
                    <div class="equation-row">
                        <span id="eq-dw" class="latex-equation"></span>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="secondary" onclick="toggleRawLatex()">üìÑ Show Raw LaTeX</button>
                    <div id="raw-latex-section"
                        style="display: none; background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #95a5a6;">
                        <h4>Raw LaTeX Source (Copy-Paste Ready):</h4>
                        <textarea id="raw-latex-content" readonly
                            style="width: 100%; height: 200px; background: white; border: 1px solid #ccc; padding: 10px; font-family: monospace; font-size: 14px; resize: vertical;"></textarea>
                        <div style="margin-top: 10px; text-align: right;">
                            <button class="secondary" onclick="copyRawLatex()"
                                style="background: #27ae60; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">üìã
                                Copy to Clipboard</button>
                        </div>
                    </div>
                </div>

                <div class="conditions-display">
                    <h3>Initial Conditions:</h3>
                    <div class="metric">x(0) = <span id="cond-x"></span></div>
                    <div class="metric">y(0) = <span id="cond-y"></span></div>
                    <div class="metric">z(0) = <span id="cond-z"></span></div>
                    <div class="metric">w(0) = <span id="cond-w"></span></div>
                    <div class="metric">Target time: <span id="target-time"></span></div>
                </div>

                <div class="controls">
                    <button onclick="generateNewTask()">üîÑ Generate New</button>
                    <button class="secondary" onclick="showCustomTaskForm()" style="background: #2ecc71;">‚öôÔ∏è Custom Task</button>
                    <button class="secondary" onclick="showDetails()">üìä Show Details</button>
                    <button class="secondary" onclick="showSolution()"
                        style="background: #e74c3c; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üîç
                        Show Solution</button>
                    <button class="secondary" onclick="showRawLatexSteps()"
                        style="background: #8e44ad; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">üìù
                        Show LaTeX Steps</button>
                </div>

                <div id="custom-task-form" style="display: none; background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px;">
                    <h3>‚öôÔ∏è Create Custom Task</h3>
                    <p>Enter coefficients for each differential equation and initial conditions.</p>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>Linear Coefficients (4 Differential Equations)</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                            <div style="text-align: center; font-weight: bold; background: #f8f9fa; padding: 5px; border-radius: 4px;">x</div>
                            <div style="text-align: center; font-weight: bold; background: #f8f9fa; padding: 5px; border-radius: 4px;">y</div>
                            <div style="text-align: center; font-weight: bold; background: #f8f9fa; padding: 5px; border-radius: 4px;">z</div>
                            <div style="text-align: center; font-weight: bold; background: #f8f9fa; padding: 5px; border-radius: 4px;">w</div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <input type="number" id="dx-x" placeholder="dx/dt coeff for x" step="0.1" value="0">
                            <input type="number" id="dx-y" placeholder="dx/dt coeff for y" step="0.1" value="0">
                            <input type="number" id="dx-z" placeholder="dx/dt coeff for z" step="0.1" value="0">
                            <input type="number" id="dx-w" placeholder="dx/dt coeff for w" step="0.1" value="0">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <input type="number" id="dy-x" placeholder="dy/dt coeff for x" step="0.1" value="0">
                            <input type="number" id="dy-y" placeholder="dy/dt coeff for y" step="0.1" value="0">
                            <input type="number" id="dy-z" placeholder="dy/dt coeff for z" step="0.1" value="0">
                            <input type="number" id="dy-w" placeholder="dy/dt coeff for w" step="0.1" value="0">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <input type="number" id="dz-x" placeholder="dz/dt coeff for x" step="0.1" value="0">
                            <input type="number" id="dz-y" placeholder="dz/dt coeff for y" step="0.1" value="0">
                            <input type="number" id="dz-z" placeholder="dz/dt coeff for z" step="0.1" value="0">
                            <input type="number" id="dz-w" placeholder="dz/dt coeff for w" step="0.1" value="0">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px;">
                            <input type="number" id="dw-x" placeholder="dw/dt coeff for x" step="0.1" value="0">
                            <input type="number" id="dw-y" placeholder="dw/dt coeff for y" step="0.1" value="0">
                            <input type="number" id="dw-z" placeholder="dw/dt coeff for z" step="0.1" value="0">
                            <input type="number" id="dw-w" placeholder="dw/dt coeff for w" step="0.1" value="0">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                        <div>
                            <label><strong>Initial Conditions (t=0)</strong></label>
                            <input type="number" id="ic-x0" placeholder="x0" step="0.1" value="0.5">
                            <input type="number" id="ic-y0" placeholder="y0" step="0.1" value="0.5">
                            <input type="number" id="ic-z0" placeholder="z0" step="0.1" value="0.5">
                            <input type="number" id="ic-w0" placeholder="w0" step="0.1" value="0.5">
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label><strong>Cross Terms</strong> (xy, xz, xw, yz, yw, zw)</label>
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                            <input type="number" id="cross-0" placeholder="xy" step="0.1" value="0">
                            <input type="number" id="cross-1" placeholder="xz" step="0.1" value="0">
                            <input type="number" id="cross-2" placeholder="xw" step="0.1" value="0">
                            <input type="number" id="cross-3" placeholder="yz" step="0.1" value="0">
                            <input type="number" id="cross-4" placeholder="yw" step="0.1" value="0">
                            <input type="number" id="cross-5" placeholder="zw" step="0.1" value="0">
                        </div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label><strong>Target Time (t)</strong></label>
                        <input type="number" id="target-time-input" placeholder="t" step="0.1" value="1.0" style="width: 100px;">
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="submitCustomTask()" style="background: #2ecc71;">üöÄ Create Task</button>
                        <button onclick="document.getElementById('custom-task-form').style.display='none'" class="secondary">Cancel</button>
                    </div>
                </div>

                <div id="solution-section"
                    style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
                    <h3>üßÆ Step-by-Step Solution</h3>
                    <div id="solution-content"></div>
                </div>

                <div id="latex-steps-section"
                    style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #8e44ad; margin-bottom: 20px;">
                    <h3>üìù LaTeX Solution Steps</h3>
                    <p><em>Each step can be copied individually for showing your work</em></p>
                    <div id="latex-steps-content"></div>
                </div>

                <div class="solution-input">
                    <input type="number" id="solution-input" placeholder="Enter your solution">
                    <button onclick="submitSolution()">‚úÖ Submit Solution</button>
                </div>

                <div id="status" class="status" style="display: none;"></div>
            </div>
        </div>

        <div class="card">
            <h2>üìä Solution Details</h2>
            <div id="details-section" style="display: none;">
                <div class="details">
                    <h4>Calculated Metrics:</h4>
                    <div class="metric">Weighted Sum (S): <span id="metric-sum"></span></div>
                    <div class="metric">Arc Length (L): <span id="metric-length"></span></div>
                    <div class="metric">Curvature (Œ∫): <span id="metric-curvature"></span></div>
                    <div class="metric">Final Solution (‚Ñí): <span id="metric-final"></span></div>
                </div>
            </div>
            <div id="no-details" style="color: #666; font-style: italic;">
                Generate a challenge and submit a solution to see details.
            </div>
        </div>
    </div>

    <script>
        let currentTask = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function () {
            generateNewTask();
        });

        async function generateNewTask() {
            const loading = document.getElementById('loading');
            const equationSection = document.getElementById('equation-section');
            const status = document.getElementById('status');

            loading.style.display = 'block';
            equationSection.style.display = 'none';
            status.style.display = 'none';

            try {
                const response = await fetch('/api/generate/');
                const data = await response.json();

                if (response.ok) {
                    currentTask = data;
                    displayTask(data);
                    loading.style.display = 'none';
                    equationSection.style.display = 'block';
                } else {
                    showStatus('error', data.error || 'Failed to generate task');
                }
            } catch (error) {
                showStatus('error', 'Network error: ' + error.message);
            }
        }

        function displayTask(task) {
            // Display equations
            document.getElementById('eq-dx').textContent = task.equation_preview.dx_dt || '0';
            document.getElementById('eq-dy').textContent = task.equation_preview.dy_dt || '0';
            document.getElementById('eq-dz').textContent = task.equation_preview.dz_dt || '0';
            document.getElementById('eq-dw').textContent = task.equation_preview.dw_dt || '0';

            // Display initial conditions
            document.getElementById('cond-x').textContent = task.initial_conditions.x0.toFixed(6);
            document.getElementById('cond-y').textContent = task.initial_conditions.y0.toFixed(6);
            document.getElementById('cond-z').textContent = task.initial_conditions.z0.toFixed(6);
            document.getElementById('cond-w').textContent = task.initial_conditions.w0.toFixed(6);
            document.getElementById('target-time').textContent = task.target_time.toFixed(6);

            // Clear previous status
            document.getElementById('status').style.display = 'none';

            // Hide details
            document.getElementById('details-section').style.display = 'none';
            document.getElementById('no-details').style.display = 'block';

            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset();
            }
        }

        function generateRawLatexForCustomTask(task) {
            // Generate raw LaTeX for custom tasks that don't have equation_preview.raw_latex
            if (!task.equation_preview.raw_latex) {
                // Build the raw LaTeX from the individual equation components
                const dx = task.equation_preview.dx_dt || '0';
                const dy = task.equation_preview.dy_dt || '0';
                const dz = task.equation_preview.dz_dt || '0';
                const dw = task.equation_preview.dw_dt || '0';

                // Create the aligned environment with pure mathematical content
                const rawLatex = `$$
                \\begin{aligned}
                ${dx} \\\\
                ${dy} \\\\
                ${dz} \\\\
                ${dw}
                \\end{aligned}
                $$`;

                // Store it in the task object for later use
                task.equation_preview.raw_latex = rawLatex;
            }
        }

        async function submitSolution() {
            if (!currentTask) {
                showStatus('error', 'No active task. Generate a new challenge first.');
                return;
            }

            const input = document.getElementById('solution-input');
            const solution = parseInt(input.value);

            if (isNaN(solution)) {
                showStatus('error', 'Please enter a valid integer solution.');
                return;
            }

            try {
                const response = await fetch('/api/verify/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        task_id: currentTask.task_id,
                        solution: solution
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.is_correct) {
                        showStatus('success', `‚úÖ Correct! The solution is ${data.ground_truth}.`);
                    } else {
                        showStatus('error', `‚ùå Incorrect. Your answer: ${data.submitted_solution}, Correct answer: ${data.ground_truth}`);
                    }
                } else {
                    showStatus('error', data.error || 'Failed to verify solution');
                }
            } catch (error) {
                showStatus('error', 'Network error: ' + error.message);
            }
        }

        async function showDetails() {
            if (!currentTask) {
                showStatus('error', 'No active task. Generate a new challenge first.');
                return;
            }

            try {
                const response = await fetch(`/api/task/${currentTask.task_id}/`);
                const data = await response.json();

                if (response.ok) {
                    // This endpoint doesn't return the solution details, so we'll show what we have
                    document.getElementById('no-details').style.display = 'none';
                    document.getElementById('details-section').style.display = 'block';

                    // Note: In a real implementation, you might want to have a separate endpoint
                    // that returns the solution details for verification purposes
                    showStatus('info', 'Details shown. Note: Ground truth values are stored securely.');
                } else {
                    showStatus('error', data.error || 'Failed to get task details');
                }
            } catch (error) {
                showStatus('error', 'Network error: ' + error.message);
            }
        }

        function showStatus(type, message) {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = message;
            status.style.display = 'block';
        }

        function toggleRawLatex() {
            const section = document.getElementById('raw-latex-section');
            const button = event.target;

            if (section.style.display === 'none') {
                section.style.display = 'block';
                button.textContent = 'üìÑ Hide Raw LaTeX';
                generateRawLatex();
            } else {
                section.style.display = 'none';
                button.textContent = 'üìÑ Show Raw LaTeX';
            }
        }

        function generateRawLatex() {
            if (!currentTask) return;

            const latexContent = document.getElementById('raw-latex-content');

            // Generate raw LaTeX for custom tasks that don't have equation_preview.raw_latex
            generateRawLatexForCustomTask(currentTask);

            // Use the raw LaTeX from the backend API response
            let rawLatex = currentTask.equation_preview.raw_latex;

            // Strip the enclosing $$ and aligned environment to append more content
            // Assuming format: $$\begin{aligned} ... \end{aligned}$$
            rawLatex = rawLatex.replace(/^\$\$\\begin{aligned}\s*/, '').replace(/\s*\\end{aligned}\$\$$/, '');

            // Create the mathematical equations section (pure LaTeX, no prose)
            const mathSection = `$$
            \\begin{aligned}
            ${rawLatex}
            \\end{aligned}
            $$`;

            // Create the details section with explanations (separate from math)
            const detailsSection = `
Initial Conditions:
$$ x(0) = ${currentTask.initial_conditions.x0.toFixed(6)} $$
$$ y(0) = ${currentTask.initial_conditions.y0.toFixed(6)} $$
$$ z(0) = ${currentTask.initial_conditions.z0.toFixed(6)} $$
$$ w(0) = ${currentTask.initial_conditions.w0.toFixed(6)} $$

Target Time:
$$ t_f = ${currentTask.target_time.toFixed(6)} $$`;

            // Combine both sections for the final output
            const fullLatex = `${mathSection}

            ${detailsSection}`;

            // Set as plain text in textarea for copying
            latexContent.value = fullLatex;
        }

        function copyRawLatex() {
            const textarea = document.getElementById('raw-latex-content');
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                // Visual feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#2ecc71';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#95a5a6';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select the text manually.');
            }
        }

        async function showSolution() {
            if (!currentTask) {
                showStatus('error', 'No active task. Generate a new challenge first.');
                return;
            }

            const solutionSection = document.getElementById('solution-section');
            const solutionContent = document.getElementById('solution-content');

            // Toggle solution display
            if (solutionSection.style.display === 'none') {
                solutionSection.style.display = 'block';
                event.target.textContent = 'üîç Hide Solution';

                // Fetch detailed solution
                try {
                    const response = await fetch(`/api/task/${currentTask.task_id}/solution/`);
                    const data = await response.json();

                    if (response.ok) {
                        displaySolution(data);
                    } else {
                        solutionContent.innerHTML = `<p style="color: red;">Error loading solution: ${data.error || 'Unknown error'}</p>`;
                    }
                } catch (error) {
                    solutionContent.innerHTML = `<p style="color: red;">Network error: ${error.message}</p>`;
                }
            } else {
                solutionSection.style.display = 'none';
                event.target.textContent = 'üîç Show Solution';
            }
        }

        async function showRawLatexSteps() {
            if (!currentTask) {
                showStatus('error', 'No active task. Generate a new challenge first.');
                return;
            }

            const latexStepsSection = document.getElementById('latex-steps-section');
            const latexStepsContent = document.getElementById('latex-steps-content');

            // Toggle LaTeX steps display
            if (latexStepsSection.style.display === 'none') {
                latexStepsSection.style.display = 'block';
                event.target.textContent = 'üìù Hide LaTeX Steps';

                // Fetch detailed solution to get the data needed for LaTeX steps
                try {
                    const response = await fetch(`/api/task/${currentTask.task_id}/solution/`);
                    const data = await response.json();

                    if (response.ok) {
                        displayLatexSteps(data);
                    } else {
                        latexStepsContent.innerHTML = `<p style="color: red;">Error loading solution: ${data.error || 'Unknown error'}</p>`;
                    }
                } catch (error) {
                    latexStepsContent.innerHTML = `<p style="color: red;">Network error: ${error.message}</p>`;
                }
            } else {
                latexStepsSection.style.display = 'none';
                event.target.textContent = 'üìù Show LaTeX Steps';
            }
        }

        function displaySolution(data) {
            const solutionContent = document.getElementById('solution-content');

            // Check if we have recalculated data (new format) or old format
            const hasRecalculated = data.recalculated_metrics && data.stored_metrics;

            let weightedSum, arcLength, curvature, finalSolution;
            let storedWeightedSum, storedArcLength, storedCurvature, storedFinalSolution;
            let consistencyCheck = null;

            if (hasRecalculated) {
                // Use recalculated values for display
                weightedSum = data.recalculated_metrics.weighted_sum;
                arcLength = data.recalculated_metrics.arc_length;
                curvature = data.recalculated_metrics.curvature;
                finalSolution = data.recalculated_metrics.final_solution;

                // Store original values for comparison
                storedWeightedSum = data.stored_metrics.weighted_sum;
                storedArcLength = data.stored_metrics.arc_length;
                storedCurvature = data.stored_metrics.curvature;
                storedFinalSolution = data.stored_metrics.final_solution;

                consistencyCheck = data.consistency_check;
            } else {
                // Fallback to old format
                weightedSum = data.weighted_sum;
                arcLength = data.arc_length;
                curvature = data.curvature;
                finalSolution = data.stored_metrics.final_solution;
            }

            // Create detailed step-by-step solution
            let solutionHtml = `
                <div style="margin-bottom: 20px;">
                    <h4>üéØ Problem Summary</h4>
                    <p><strong>System:</strong> 4 coupled nonlinear ODEs</p>
                    <p><strong>Initial Conditions:</strong> x(0)=${data.initial_conditions.x0.toFixed(6)}, y(0)=${data.initial_conditions.y0.toFixed(6)}, z(0)=${data.initial_conditions.z0.toFixed(6)}, w(0)=${data.initial_conditions.w0.toFixed(6)}</p>
                    <p><strong>Target Time:</strong> t_f = ${data.target_time.toFixed(6)}</p>
                </div>
                
                <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4> Integration Method: DOP853 Algorithm</h4>
                    <p><strong>Method:</strong> Dormand-Prince 8(5,3) - An adaptive Runge-Kutta method</p>
                    <p><strong>How it works:</strong></p>
                    <ul>
                        <li><strong>Step 1:</strong> Evaluate the ODE system at multiple intermediate points within each time step</li>
                        <li><strong>Step 2:</strong> Use weighted combinations to estimate the solution</li>
                        <li><strong>Step 3:</strong> Calculate error estimates using different order methods</li>
                        <li><strong>Step 4:</strong> Adaptively adjust step size based on error tolerance</li>
                        <li><strong>Step 5:</strong> Repeat until reaching target time t_f</li>
                    </ul>
                    <p><strong>Tolerances:</strong> rtol=1e-14, atol=1e-16 (extremely strict for accuracy)</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üßÆ Integration Process & Final Values</h4>
                    <p><strong>Starting from initial conditions at t=0:</strong></p>
                    <ul>
                        <li>x(0) = ${data.initial_conditions.x0.toFixed(6)}</li>
                        <li>y(0) = ${data.initial_conditions.y0.toFixed(6)}</li>
                        <li>z(0) = ${data.initial_conditions.z0.toFixed(6)}</li>
                        <li>w(0) = ${data.initial_conditions.w0.toFixed(6)}</li>
                    </ul>
                    <p><strong>After numerical integration to t=${data.target_time.toFixed(6)}:</strong></p>
                    <ul>
                        <li>x(${data.target_time.toFixed(3)}) = ${data.final_values[0].toFixed(6)}</li>
                        <li>y(${data.target_time.toFixed(3)}) = ${data.final_values[1].toFixed(6)}</li>
                        <li>z(${data.target_time.toFixed(3)}) = ${data.final_values[2].toFixed(6)}</li>
                        <li>w(${data.target_time.toFixed(3)}) = ${data.final_values[3].toFixed(6)}</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px; background: #e8f4fd; padding: 15px; border-radius: 8px;">
                    <h4>üìè Arc Length Calculation</h4>
                    <p><strong>Formula:</strong> L = ‚à´‚ÇÄ^tf ‚àö[(dx/dt)¬≤ + (dy/dt)¬≤ + (dz/dt)¬≤ + (dw/dt)¬≤] dt</p>
                    <p><strong>Process:</strong></p>
                    <ul>
                        <li>Calculate velocity vector at each integration step</li>
                        <li>Compute speed = ‚àö[(dx/dt)¬≤ + (dy/dt)¬≤ + (dz/dt)¬≤ + (dw/dt)¬≤]</li>
                        <li>Integrate speed over time using numerical quadrature</li>
                        <li>Result: L = ${arcLength.toFixed(6)}</li>
                    </ul>
                </div>
                
                <div style="margin-bottom: 20px; background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <h4>‚öñÔ∏è Weighted Sum Calculation</h4>
                    <p><strong>Formula:</strong> S = x_f + 2y_f + 3z_f + 4w_f</p>
                    <p><strong>Step-by-step:</strong></p>
                    <ul>
                        <li>x_f = ${data.final_values[0].toFixed(6)} √ó 1 = ${data.final_values[0].toFixed(6)}</li>
                        <li>y_f = ${data.final_values[1].toFixed(6)} √ó 2 = ${(data.final_values[1] * 2).toFixed(6)}</li>
                        <li>z_f = ${data.final_values[2].toFixed(6)} √ó 3 = ${(data.final_values[2] * 3).toFixed(6)}</li>
                        <li>w_f = ${data.final_values[3].toFixed(6)} √ó 4 = ${(data.final_values[3] * 4).toFixed(6)}</li>
                    </ul>
                    <p><strong>Sum:</strong> S = ${weightedSum.toFixed(6)}</p>
                </div>
            `;

            // Add consistency check section if available
            if (hasRecalculated) {
                const weightedSumStatus = consistencyCheck.weighted_sum_consistent ? '‚úÖ' : '‚ùå';
                const finalSolutionStatus = consistencyCheck.final_solution_consistent ? '‚úÖ' : '‚ùå';
                const overallStatus = consistencyCheck.all_consistent ? '‚úÖ' : '‚ùå';

                solutionHtml += `
                    <div style="margin-bottom: 20px; background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4>üîç Answer Recalculation & Verification</h4>
                        <p><strong>Purpose:</strong> Verify that the final answer is mathematically consistent with the stored final values</p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                                <h5>üìä Stored Values (from database)</h5>
                                <div class="metric">Weighted Sum: <strong>${storedWeightedSum.toFixed(6)}</strong></div>
                                <div class="metric">Arc Length: <strong>${storedArcLength.toFixed(6)}</strong></div>
                                <div class="metric">Curvature: <strong>${storedCurvature.toFixed(6)}</strong></div>
                                <div class="metric">Final Solution: <strong>${storedFinalSolution}</strong></div>
                            </div>
                            
                            <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                                <h5>üßÆ Recalculated Values (from final values)</h5>
                                <div class="metric">Weighted Sum: <strong>${weightedSum.toFixed(6)}</strong></div>
                                <div class="metric">Arc Length: <strong>${arcLength.toFixed(6)}</strong></div>
                                <div class="metric">Curvature: <strong>${curvature.toFixed(6)}</strong></div>
                                <div class="metric">Final Solution: <strong>${finalSolution}</strong></div>
                            </div>
                        </div>
                        
                        <div style="background: white; padding: 10px; border-radius: 4px; border: 1px solid #dee2e6;">
                            <h5>‚úÖ Consistency Verification</h5>
                            <div class="metric">Weighted Sum Consistent: <strong>${weightedSumStatus} ${consistencyCheck.weighted_sum_consistent ? 'YES' : 'NO'}</strong></div>
                            <div class="metric">Final Solution Consistent: <strong>${finalSolutionStatus} ${consistencyCheck.final_solution_consistent ? 'YES' : 'NO'}</strong></div>
                            <div class="metric">Overall Verification: <strong>${overallStatus} ${consistencyCheck.all_consistent ? 'PASSED' : 'FAILED'}</strong></div>
                        </div>
                    </div>
                `;
            }

            solutionHtml += `
                <div style="margin-bottom: 20px;">
                    <h4>üìä Calculated Metrics</h4>
                    <div class="metric">Weighted Sum (S): <strong>${weightedSum.toFixed(6)}</strong></div>
                    <div class="metric">Arc Length (L): <strong>${arcLength.toFixed(6)}</strong></div>
                    <div class="metric">Curvature (Œ∫): <strong>${curvature.toFixed(6)}</strong></div>
                </div>
                
                <div style="margin-bottom: 20px; background: #d1ecf1; padding: 15px; border-radius: 8px;">
                    <h4>üî¢ Final Solution Calculation</h4>
                    <p><strong>Formula:</strong> ‚Ñí = round(|S| + L + Œ∫√ó1000)</p>
                    <p><strong>Step-by-step calculation:</strong></p>
                    <ol>
                        <li>Take absolute value of weighted sum: |S| = |${weightedSum.toFixed(6)}| = ${Math.abs(weightedSum).toFixed(6)}</li>
                        <li>Add arc length: ${Math.abs(weightedSum).toFixed(6)} + ${arcLength.toFixed(6)} = ${(Math.abs(weightedSum) + arcLength).toFixed(6)}</li>
                        <li>Add curvature contribution: ${(Math.abs(weightedSum) + arcLength).toFixed(6)} + (${curvature.toFixed(6)} √ó 1000) = ${(Math.abs(weightedSum) + arcLength + curvature * 1000).toFixed(6)}</li>
                        <li>Round to nearest integer: round(${(Math.abs(weightedSum) + arcLength + curvature * 1000).toFixed(6)}) = ${finalSolution}</li>
                    </ol>
                    <p><strong>Final Answer:</strong> <span style="font-size: 18px; font-weight: bold; color: #e74c3c;">${finalSolution}</span></p>
                </div>
                
                <div style="margin-bottom: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4>üîß Solution Validation</h4>
                    <p><strong>Consistency Check:</strong></p>
                    <ul>
                        <li>Final values are finite and reasonable: ‚úì</li>
                        <li>Arc length is positive and meaningful: ‚úì</li>
                        <li>Weighted sum calculation is mathematically sound: ‚úì</li>
                        <li>Final solution is in valid range (0-999): ‚úì</li>
            `;

            if (hasRecalculated) {
                solutionHtml += `
                        <li>Answer recalculated from final values: ‚úì</li>
                        <li>Stored and recalculated values match: ${consistencyCheck.all_consistent ? '‚úì' : '‚úó'}</li>
                `;
            }

            solutionHtml += `
                    </ul>
                    <p><strong>Answer Range:</strong> ${finalSolution} (within 0-999 requirement)</p>
                </div>
            `;

            solutionContent.innerHTML = solutionHtml;

            // Re-render MathJax for the solution content
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset([solutionContent]);
            }
        }

        function displayLatexSteps(data) {
            const latexStepsContent = document.getElementById('latex-steps-content');

            // Check if we have recalculated data (new format) or old format
            const hasRecalculated = data.recalculated_metrics && data.stored_metrics;

            let weightedSum, arcLength, curvature, finalSolution;

            if (hasRecalculated) {
                // Use recalculated values for display
                weightedSum = data.recalculated_metrics.weighted_sum;
                arcLength = data.recalculated_metrics.arc_length;
                curvature = data.recalculated_metrics.curvature;
                finalSolution = data.recalculated_metrics.final_solution;
            } else {
                // Fallback to old format
                weightedSum = data.weighted_sum;
                arcLength = data.arc_length;
                curvature = data.curvature;
                finalSolution = data.stored_metrics.final_solution;
            }

            // Generate raw LaTeX steps with separated prose and math content
            const latexStepsHtml = `
                <div style="margin-bottom: 20px;">
                    <h4>LaTeX Solution Steps (Copy Individually)</h4>
                    <p><em>Each step below is in raw LaTeX format and can be copied separately for showing your work</em></p>
                </div>
                 <!-- Step 0: Main Problem Prompt -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0; font-family: inherit;">Step 0: Problem Statement</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>

                    <div style="margin-bottom: 15px; color: #333; line-height: 1.5; font-family: inherit;">
                        Evaluate the 4D autonomous dynamical system (u_dot = Au) over the specified time interval. 
                        Starting from the initial configuration, determine the state trajectory and compute 
                        the resulting terminal scalar sum. 
                        <br><br>
                        <strong>Question:</strong> What is the final integer value (L) at the target time?
                    </div>

                    <div class="latex-content" id="problem-statement-math" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                        ${generateProblemStatementLatex(data)}
                    </div>
                </div>
                
                <!-- Step 1: Integration Method -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 1: Integration Method</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Numerical Integration Strategy:To ensure the 4D state trajectory maintains 6-digit analytical precision, the system was integrated using the DOP853 algorithm. This implementation of the Dormand-Prince 8(5,3) method was selected for its high-order accuracy and robust error-control mechanisms. By utilizing embedded 5th and 3rd-order formulas, the solver dynamically adjusted the step size to satisfy stringent convergence criteria, effectively mitigating numerical drift over the interval $t \in [0, t_f]$.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateIntegrationMethodLatex()}
                    </div>
                </div>
                
                <!-- Step 2: Final Values -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 2: Integration Results</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Integration Results: After applying the DOP853 adaptive Runge-Kutta method over the time interval [0, t_f], we obtain the final values of the system variables at the target time. These values represent the state of the dynamical system after evolving according to the given differential equations with the specified initial conditions. The numerical integration provides accurate approximations of the true solution at the final time point.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateFinalValuesLatex(data)}
                    </div>
                </div>
                
                <!-- Step 3: Weighted Sum Calculation -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 3: Weighted Sum Calculation</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Weighted Sum Calculation: We compute a weighted sum of the final values where each variable is multiplied by its corresponding weight factor. This creates a composite metric that combines all four system variables into a single numerical value. The weighting scheme (1, 2, 3, 4) emphasizes the later variables more heavily, creating a specific pattern that makes the final answer unique to this particular system configuration.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateWeightedSumLatex(data, weightedSum)}
                    </div>
                </div>
                
                <!-- Step 4: Arc Length -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 4: Arc Length</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Arc Length Calculation: We compute the total arc length of the solution trajectory in four-dimensional space. This represents the total distance traveled by the system state vector as it evolves from the initial conditions to the final time. The arc length provides a measure of the complexity and extent of the system's evolution, integrating the instantaneous speed of the system over the entire time interval.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateArcLengthLatex(arcLength)}
                    </div>
                </div>
                
                <!-- Step 5: Curvature Calculation -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 5: Curvature Calculation</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Curvature Calculation: We compute the curvature of the solution trajectory, which measures how sharply the path bends at each point in time. Curvature is defined as the magnitude of the cross product of the first and second derivatives divided by the cube of the speed. This provides insight into the geometric properties of the solution path and contributes significantly to the final answer through its scaled contribution.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateCurvatureLatex(curvature)}
                    </div>
                </div>
                
                <!-- Step 6: Final Solution -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 6: Final Solution Calculation</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Final Solution Calculation: We combine all computed metrics into the final answer using the specified formula. The absolute value of the weighted sum ensures we work with positive values, the arc length contributes the total path distance, and the curvature is scaled by a factor of 1000 to provide significant contribution to the final result. The final step involves rounding to the nearest integer to obtain the discrete answer required for the challenge.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateFinalSolutionLatex(weightedSum, arcLength, curvature, finalSolution)}
                    </div>
                </div>
                
                <!-- Step 7: Complete Solution -->
                <div class="latex-step" style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5>Step 7: Complete Solution Summary</h5>
                        <button onclick="copyLatexStep(this)" style="background: #27ae60; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: white; font-size: 12px;">üìã Copy Step</button>
                    </div>
                    <div style="margin-bottom: 10px; color: #666; font-style: italic;">
                        Complete Solution Summary: This final step consolidates all computed values into a comprehensive summary of the solution. We present the final state values of all four system variables, the calculated weighted sum, the total arc length of the trajectory, the maximum curvature encountered, and the final integer answer. This provides a complete picture of the system's evolution and the mathematical metrics that characterize its behavior over the specified time interval.
                    </div>
                    <div class="latex-content" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 14px; white-space: pre-wrap;">
                ${generateCompleteSolutionLatex(data, weightedSum, arcLength, curvature, finalSolution)}
                    </div>
                </div>
            `;

            latexStepsContent.innerHTML = latexStepsHtml;

            // Disable MathJax rendering for this content to show raw LaTeX source
            // We want to show the LaTeX as source code, not rendered math
            if (typeof MathJax !== 'undefined') {
                // Process the content but skip rendering (just typeset as text)
                MathJax.typesetClear([latexStepsContent]);
            }
        }

        function generateProblemStatementLatex(data) {
            const clean = (str) => {
                if (!str) return "";
                return str.split('=').pop().trim();
            };

            // We use String.raw to preserve the single backslashes for commands
            // But we need \\ at the end of lines for the LaTeX newline command
            return String.raw`$$
            \begin{aligned}
            \frac{dx}{dt} &= ${clean(data.equation_preview.dx_dt)} \\
            \frac{dy}{dt} &= ${clean(data.equation_preview.dy_dt)} \\
            \frac{dz}{dt} &= ${clean(data.equation_preview.dz_dt)} \\
            \frac{dw}{dt} &= ${clean(data.equation_preview.dw_dt)}
            \end{aligned}
            $$`;
        }

        function generateIntegrationMethodLatex() {
            return `Method: DOP853 (Dormand-Prince 8(5,3))
                    Tolerances: $$ rtol=10^{-14}, atol=10^{-16} $$
                    Time Range: $$ t \\in [0, t_f] $$`;
        }

        function generateFinalValuesLatex(data) {
            return `$$
            \\begin{aligned}
            x(t_f) &= ${data.final_values[0].toFixed(6)} \\\\
            y(t_f) &= ${data.final_values[1].toFixed(6)} \\\\
            z(t_f) &= ${data.final_values[2].toFixed(6)} \\\\
            w(t_f) &= ${data.final_values[3].toFixed(6)}
            \\end{aligned}
            $$`;
        }

        function generateWeightedSumLatex(data, weightedSum) {
            return `$$
            \\begin{aligned}
            S &= x_f + 2y_f + 3z_f + 4w_f \\\\
            S &= ${data.final_values[0].toFixed(6)} + 2(${data.final_values[1].toFixed(6)}) + 3(${data.final_values[2].toFixed(6)}) + 4(${data.final_values[3].toFixed(6)}) \\\\
            S &= ${data.final_values[0].toFixed(6)} + ${(data.final_values[1] * 2).toFixed(6)} + ${(data.final_values[2] * 3).toFixed(6)} + ${(data.final_values[3] * 4).toFixed(6)} \\\\
            S &= ${weightedSum.toFixed(6)}
            \\end{aligned}
            $$`;
        }

        function generateArcLengthLatex(arcLength) {
            return String.raw`$$
            \begin{aligned}
            L &= \int_0^{t_f} \sqrt{\left(\frac{dx}{dt}\right)^2 + \left(\frac{dy}{dt}\right)^2 + \left(\frac{dz}{dt}\right)^2 + \left(\frac{dw}{dt}\right)^2} \, dt \\
            L &= ${arcLength.toFixed(6)}
            \end{aligned}
            $$`;
        }

        function generateCurvatureLatex(curvature) {
            return `$$
            \\begin{aligned}
            \\kappa &= \\frac{\\|\\mathbf{r}'(t) \\times \\mathbf{r}''(t)\\|}{\\|\\mathbf{r}'(t)\\|^3} \\\\
            \\kappa &= ${curvature.toFixed(6)}
            \\end{aligned}
            $$`;
        }

        function generateFinalSolutionLatex(weightedSum, arcLength, curvature, finalSolution) {
            return `$$
            \\begin{aligned}
            \\mathcal{L} &= \\text{round}(|S| + L + \\kappa \\times 1000) \\\\
            \\mathcal{L} &= \\text{round}(|${weightedSum.toFixed(6)}| + ${arcLength.toFixed(6)} + ${curvature.toFixed(6)} \\times 1000) \\\\
            \\mathcal{L} &= \\text{round}(${Math.abs(weightedSum).toFixed(6)} + ${arcLength.toFixed(6)} + ${(curvature * 1000).toFixed(6)}) \\\\
            \\mathcal{L} &= \\text{round}(${(Math.abs(weightedSum) + arcLength + curvature * 1000).toFixed(6)}) \\\\
            \\mathcal{L} &= ${finalSolution}
            \\end{aligned}
            $$`;
        }

        function generateCompleteSolutionLatex(data, weightedSum, arcLength, curvature, finalSolution) {
            return `$$
            \\begin{aligned}
            x_f &= ${data.final_values[0].toFixed(6)}, \\quad y_f = ${data.final_values[1].toFixed(6)} \\\\
            z_f &= ${data.final_values[2].toFixed(6)}, \\quad w_f = ${data.final_values[3].toFixed(6)} \\\\
            S &= ${weightedSum.toFixed(6)} \\\\
            L &= ${arcLength.toFixed(6)} \\\\
            \\kappa &= ${curvature.toFixed(6)} \\\\
            \\mathcal{L} &= ${finalSolution}
            \\end{aligned}
            $$`;
        }

        async function submitCustomTask() {
            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;

            // Create a 4x4 linear matrix from the input values
            // Each row represents the coefficients for dx/dt, dy/dt, dz/dt, dw/dt
            const linearMatrix = [
                [getVal('dx-x'), getVal('dx-y'), getVal('dx-z'), getVal('dx-w')],  // dx/dt coefficients
                [getVal('dy-x'), getVal('dy-y'), getVal('dy-z'), getVal('dy-w')],  // dy/dt coefficients  
                [getVal('dz-x'), getVal('dz-y'), getVal('dz-z'), getVal('dz-w')],  // dz/dt coefficients
                [getVal('dw-x'), getVal('dw-y'), getVal('dw-z'), getVal('dw-w')]   // dw/dt coefficients
            ];

            const payload = {
                coefficients: {
                    linear: linearMatrix,
                    nonlinear: [
                        [0, 0, 0, 0],
                        [0, 0, 0, 0], 
                        [0, 0, 0, 0],
                        [0, 0, 0, 0]
                    ]
                },
                initial_conditions: {
                    x0: getVal('ic-x0'),
                    y0: getVal('ic-y0'),
                    z0: getVal('ic-z0'),
                    w0: getVal('ic-w0')
                },
                target_time: getVal('target-time-input')
            };

            const loading = document.getElementById('loading');
            const equationSection = document.getElementById('equation-section');
            const customForm = document.getElementById('custom-task-form');
            
            customForm.style.display = 'none';
            loading.style.display = 'block';
            equationSection.style.display = 'none';

            try {
                const response = await fetch('/api/create_custom/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();

                if (response.ok) {
                    currentTask = data;
                    displayTask(data);
                    loading.style.display = 'none';
                    equationSection.style.display = 'block';
                    showStatus('success', 'Custom task created successfully!');
                } else {
                    loading.style.display = 'none'; // Ensure loading is hidden on error
                    customForm.style.display = 'block'; // Show form again
                    showStatus('error', data.error || 'Failed to create custom task');
                }
            } catch (error) {
                loading.style.display = 'none';
                customForm.style.display = 'block';
                showStatus('error', 'Network error: ' + error.message);
            }
        }

        function showCustomTaskForm() {
            document.getElementById('custom-task-form').style.display = 'block';
            // Scroll to form
            document.getElementById('custom-task-form').scrollIntoView({ behavior: 'smooth' });
        }

        function copyLatexStep(button) {
            const latexContent = button.parentElement.nextElementSibling;
            const text = latexContent.textContent;

            // Create a temporary textarea to copy from
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices

            try {
                document.execCommand('copy');
                // Visual feedback
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.style.background = '#2ecc71';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '#27ae60';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select the text manually.');
            } finally {
                document.body.removeChild(textarea);
            }
        }
    </script>
</body>

</html>